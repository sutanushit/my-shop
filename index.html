<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Shop</title>
    <style>
        table {
            min-width: 50px;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th {
            background-color: darksalmon;
        }

        th,
        td {
            text-align: right;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        td:nth-child(5),
        td:nth-child(8) {
            font-weight: bold;
            background-color: rgb(249, 249, 19);
        }

        .button {
            margin: 1px;
        }

        /* Modal styling */
        #itemForm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 75%;
            max-height: 90vh;
            display: none;
            overflow-y: auto;
        }

        #itemForm::before {
            content: '';
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        #itemForm.show {
            display: block !important;
        }

        #itemForm.show::before {
            display: block !important;
        }

        #itemForm .form-title {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        #itemForm form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #itemForm label {
            font-weight: bold;
            margin-top: 5px;
            color: #333;
        }

        #itemForm input,
        #itemForm select {
            padding: 12px 8px 8px 8px;
            border: 1px solid #999;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #000;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        #itemForm input::placeholder {
            color: #999;
        }

        #itemForm input:focus,
        #itemForm select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .form-group {
            position: relative;
            margin-bottom: 15px;
        }

        .form-group label {
            position: absolute;
            top: -12px;
            left: 8px;
            background-color: white;
            padding: 0 4px;
            font-size: 12px;
            font-weight: bold;
            color: #4CAF50;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label,
        .form-group select:focus + label,
        .form-group select:not(:placeholder-shown) + label {
            opacity: 1;
            transform: translateY(0);
        }

        #itemForm button {
            padding: 10px 15px;
            margin-top: 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: background-color 0.2s;
            flex: 1;
            margin-right: 8px;
        }

        #itemForm button:last-of-type {
            margin-right: 0;
        }

        .button-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        #itemForm button[type="button"]:first-of-type {
            background-color: #4CAF50;
            color: white;
        }

        #itemForm button[type="button"]:first-of-type:hover {
            background-color: #45a049;
        }

        #itemForm button[type="button"]:last-of-type {
            background-color: #f44336;
            color: white;
        }

        #itemForm button[type="button"]:last-of-type:hover {
            background-color: #da190b;
        }

        /* Product Management Modal */
        #productManagementModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            display: none;
            overflow-y: auto;
        }

        #productManagementModal.show {
            display: block !important;
        }

        #productManagementModal.show::before {
            display: block !important;
        }

        #productManagementModal::before {
            content: '';
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .product-modal-title {
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .product-table {
            width: 100%;
            margin-bottom: 20px;
        }

        .product-table thead {
            background-color: #4CAF50;
            color: white;
        }

        .product-table th, .product-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .product-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .product-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .product-actions {
            display: flex;
            gap: 5px;
        }

        .product-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .edit-btn {
            background-color: #2196F3;
            color: white;
        }

        .edit-btn:hover {
            background-color: #0b7dda;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background-color: #da190b;
        }

        .add-product-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }

        .add-product-btn:hover {
            background-color: #45a049;
        }

        #productForm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            display: none;
            overflow-y: auto;
        }

        #productForm::before {
            content: '';
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        #productForm.show {
            display: block !important;
        }

        #productForm.show::before {
            display: block !important;
        }

        #productForm .form-title {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        #productForm form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #productForm input,
        #productForm select {
            padding: 12px 8px 8px 8px;
            border: 1px solid #999;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            color: #000;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        #productForm input::placeholder {
            color: #999;
        }

        #productForm input:focus,
        #productForm select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .product-form-group {
            position: relative;
            margin-bottom: 15px;
        }

        .product-form-group label {
            position: absolute;
            top: -12px;
            left: 8px;
            background-color: white;
            padding: 0 4px;
            font-size: 12px;
            font-weight: bold;
            color: #4CAF50;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .product-form-group input:focus + label,
        .product-form-group input:not(:placeholder-shown) + label {
            opacity: 1;
            transform: translateY(0);
        }

        #productForm button {
            padding: 10px 15px;
            margin-top: 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: background-color 0.2s;
            flex: 1;
            margin-right: 8px;
        }

        #productForm button:last-of-type {
            margin-right: 0;
        }

        .product-button-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        #productForm button[type="button"]:first-of-type {
            background-color: #4CAF50;
            color: white;
        }

        #productForm button[type="button"]:first-of-type:hover {
            background-color: #45a049;
        }

        #productForm button[type="button"]:last-of-type {
            background-color: #f44336;
            color: white;
        }

        #productForm button[type="button"]:last-of-type:hover {
            background-color: #da190b;
        }

        /* Invoice List Modal */
        #invoiceListModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            display: none;
            overflow-y: auto;
        }

        #invoiceListModal.show {
            display: block !important;
        }

        #invoiceListModal.show::before {
            display: block !important;
        }

        #invoiceListModal::before {
            content: '';
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .invoice-modal-title {
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .invoice-date-filter {
            margin-bottom: 15px;
        }

        .invoice-date-filter label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .invoice-date-filter input {
            width: 100%;
            padding: 8px;
            border: 1px solid #999;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .invoice-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        .invoice-table thead {
            background-color: #2196F3;
            color: white;
        }

        .invoice-table th, .invoice-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .invoice-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .invoice-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .invoice-actions {
            display: flex;
            gap: 5px;
        }

        .invoice-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .open-invoice-btn {
            background-color: #4CAF50;
            color: white;
        }

        .open-invoice-btn:hover {
            background-color: #45a049;
        }

        .delete-invoice-btn {
            background-color: #f44336;
            color: white;
        }

        .delete-invoice-btn:hover {
            background-color: #da190b;
        }

        .add-invoice-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            flex: 1;
        }

        .add-invoice-btn:hover {
            background-color: #45a049;
        }

        .invoice-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .invoice-modal-buttons button {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .close-modal-btn {
            background-color: #f44336;
            color: white;
        }

        .close-modal-btn:hover {
            background-color: #da190b;
        }

        .available-dates-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border: 1px solid #2196F3;
            border-radius: 4px;
        }

        .available-dates-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .available-dates-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .date-badge {
            background-color: #2196F3;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .date-badge:hover {
            background-color: #0b7dda;
            transform: scale(1.05);
        }

        .date-badge.active {
            background-color: #4CAF50;
            border-color: #333;
        }

        .date-badge-count {
            font-size: 10px;
            margin-left: 4px;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <input type="date" id="datePicker" onchange="updateInvoiceDate()" style="margin-left: 10px; display:none;">
    <button onclick="openInvoiceList()" style="margin-left: 10px;">üìã Invoices</button>
    <button onclick="openProductManagement()" style="margin-left: 10px;">‚öôÔ∏è Products</button>
    </br>
    <h1></h1>
    <table id="invoiceHeader">
        <thead>
            <tr>
                <th>Invoice Date: <span id="invoiceDate"></span> | Serial #: <span id="invoiceSerial">-</span></th>
                
            </tr>
    </table>
    <table id="invoiceTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Weight</th>
                <th>Rate</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Cost</th>
                <th>Unit Cost</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Items will be added here dynamically -->
        </tbody>
    </table>
    <br>
    Total quantity: <b><span id="totalQuantity">0</span></b>,
    Total Price: <b><span id="totalPrice">0.00</span></b>
    <br>
    <br>
    <button onclick="openForm()">+</button>
    <button onclick="shareInvoice()" style="margin-left:10px;">Share</button>

    <div id="itemForm">
        <div class="form-title">Item Details</div>
        <form id="form">
            <div class="form-group">
                <label for="productSelect">Product</label>
                <select id="productSelect" onchange="onProductSelectChange()">
                    <option value="">-- Select product --</option>
                    <option value="add_new">+ Add new product...</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="productName" name="productName" placeholder="Product Name" required>
                <label for="productName">Product Name</label>
            </div>
            <div class="form-group">
                <input type="number" id="netWeight" name="netWeight" placeholder="Net Weight" required>
                <label for="netWeight">Net Weight</label>
            </div>
            <div class="form-group">
                <input type="number" id="quantity" name="quantity" placeholder="Quantity" required>
                <label for="quantity">Quantity</label>
            </div>
            <div class="form-group">
                <input type="number" id="rate" name="rate" placeholder="Rate" required>
                <label for="rate">Rate</label>
            </div>
            <div class="form-group">
                <input type="number" id="cost" name="cost" placeholder="Cost" value="3" required>
                <label for="cost">Cost</label>
            </div>
            <div class="button-container">
                <button type="button" onclick="submitForm()">Submit</button>
                <button type="button" onclick="closeForm()">Cancel</button>
            </div>
        </form>
    </div>

    <div id="invoiceListModal">
        <div class="invoice-modal-title">Manage Invoices</div>
        <div class="available-dates-section">
            <div class="available-dates-title">üìÖ Available Dates</div>
            <div id="availableDatesList" class="available-dates-list">
                <span style="font-size: 12px; color: #999;">Loading dates...</span>
            </div>
        </div>
        <div class="invoice-date-filter">
            <label for="invoiceListDate">Select Date:</label>
            <input type="date" id="invoiceListDate" onchange="refreshInvoiceList()">
        </div>
        <div id="invoiceListContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
            <p>Select a date to view invoices</p>
        </div>
        <div class="invoice-modal-buttons">
            <button type="button" class="add-invoice-btn" onclick="createNewInvoice()">+ New Invoice</button>
            <button type="button" class="close-modal-btn" onclick="closeInvoiceList()">Close</button>
        </div>
    </div>

    <!-- Product Management Modal -->
    <div id="productManagementModal">
        <div class="product-modal-title">Product Management</div>
        <button class="add-product-btn" onclick="openProductForm()">+ Add Product</button>
        <div id="productTableContainer"></div>
        <br>
        <button type="button" onclick="closeProductManagement()" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Close</button>
    </div>

    <!-- Product Form Modal -->
    <div id="productForm">
        <div class="form-title">Product Details</div>
        <form id="productFormElement">
            <div class="product-form-group">
                <input type="text" id="productId" name="productId" placeholder="Product ID" required readonly>
                <label for="productId">Product ID</label>
            </div>
            <div class="product-form-group">
                <input type="text" id="productNameInput" name="productNameInput" placeholder="Product Name" required>
                <label for="productNameInput">Product Name</label>
            </div>
            <div class="product-form-group">
                <input type="number" id="productWeightInput" name="productWeightInput" placeholder="Weight" required>
                <label for="productWeightInput">Weight</label>
            </div>
            <div class="product-form-group">
                <input type="number" id="productCostInput" name="productCostInput" placeholder="Default Cost" step="0.01" required>
                <label for="productCostInput">Default Cost</label>
            </div>
            <div class="product-button-container">
                <button type="button" onclick="submitProductForm()">Submit</button>
                <button type="button" onclick="closeProductForm()">Cancel</button>
            </div>
        </form>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let items = [];
        let editingIndex = -1;
        let currentInvoiceDate = '';
        let currentInvoiceSerial = 1;

        // Get storage key for invoices on a specific date
        function getInvoiceStorageKey(date) {
            return `invoices_${date}`;
        }

        // Get all invoices for a specific date
        function getInvoicesForDate(date) {
            const key = getInvoiceStorageKey(date);
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading invoices:', e);
                    return [];
                }
            }
            return [];
        }

        // Get next serial number for a date
        function getNextSerialNumber(date) {
            const invoices = getInvoicesForDate(date);
            if (invoices.length === 0) return 1;
            const maxSerial = Math.max(...invoices.map(inv => inv.serialNumber));
            return maxSerial + 1;
        }

        // Get all dates that have invoices
        function getAllInvoiceDates() {
            const dates = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('invoices_')) {
                    const date = key.replace('invoices_', '');
                    const invoices = getInvoicesForDate(date);
                    if (invoices.length > 0) {
                        dates.push({ date, count: invoices.length });
                    }
                }
            }
            // Sort dates in descending order (newest first)
            dates.sort((a, b) => new Date(b.date) - new Date(a.date));
            return dates;
        }

        // Render available dates list
        function renderAvailableDates() {
            const container = document.getElementById('availableDatesList');
            const dates = getAllInvoiceDates();
            const selectedDate = document.getElementById('invoiceListDate').value;

            if (dates.length === 0) {
                container.innerHTML = '<span style="font-size: 12px; color: #999;">No invoices yet. Create one!</span>';
                return;
            }

            let html = '';
            dates.forEach(({ date, count }) => {
                const isActive = date === selectedDate ? 'active' : '';
                const displayDate = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                html += `<div class="date-badge ${isActive}" onclick="selectDateFromBadge('${date}')">${displayDate}<span class="date-badge-count">(${count})</span></div>`;
            });
            container.innerHTML = html;
        }

        // Select date from badge click
        function selectDateFromBadge(date) {
            document.getElementById('invoiceListDate').value = date;
            refreshInvoiceList();
            renderAvailableDates();
        }

        // Load a specific invoice
        function loadInvoice(date, serialNumber) {
            const invoices = getInvoicesForDate(date);
            const invoice = invoices.find(inv => inv.serialNumber === serialNumber);
            if (invoice) {
                currentInvoiceDate = date;
                currentInvoiceSerial = serialNumber;
                items = invoice.items || [];
                updateDisplay();
            }
        }

        // Save current invoice
        function saveCurrentInvoice() {
            if (!currentInvoiceDate) return;

            const invoices = getInvoicesForDate(currentInvoiceDate);
            const invoiceIndex = invoices.findIndex(inv => inv.serialNumber === currentInvoiceSerial);
            
            const invoice = {
                serialNumber: currentInvoiceSerial,
                date: currentInvoiceDate,
                items: items,
                lastModified: new Date().toISOString()
            };

            if (invoiceIndex >= 0) {
                invoices[invoiceIndex] = invoice;
            } else {
                invoices.push(invoice);
            }

            const key = getInvoiceStorageKey(currentInvoiceDate);
            localStorage.setItem(key, JSON.stringify(invoices));
        }

        // Update display with current invoice info
        function updateDisplay() {
            document.getElementById('invoiceDate').innerText = new Date(currentInvoiceDate).toLocaleDateString();
            document.getElementById('invoiceSerial').innerText = currentInvoiceSerial;
            updateTable();
        }

        // Create new invoice for selected date
        function createNewInvoice() {
            const dateInput = document.getElementById('invoiceListDate').value;
            if (!dateInput) {
                alert('Please select a date first');
                return;
            }
            items = [];
            currentInvoiceDate = dateInput;
            currentInvoiceSerial = getNextSerialNumber(dateInput);
            document.getElementById('datePicker').value = dateInput;
            saveCurrentInvoice();
            closeInvoiceList();
            updateDisplay();
        }

        // Open invoice list modal
        function openInvoiceList() {
            document.getElementById('invoiceListModal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceListDate').value = today;
            refreshInvoiceList();
            renderAvailableDates();
        }

        // Close invoice list modal
        function closeInvoiceList() {
            document.getElementById('invoiceListModal').classList.remove('show');
        }

        // Refresh invoice list for selected date
        function refreshInvoiceList() {
            const selectedDate = document.getElementById('invoiceListDate').value;
            if (!selectedDate) return;

            const invoices = getInvoicesForDate(selectedDate);
            const container = document.getElementById('invoiceListContainer');

            if (invoices.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No invoices for this date. Create a new one!</p>';
                return;
            }

            let html = '<table class="invoice-table"><thead><tr><th>Serial #</th><th>Items</th><th>Last Modified</th><th>Actions</th></tr></thead><tbody>';
            invoices.forEach(invoice => {
                const itemCount = invoice.items ? invoice.items.length : 0;
                const lastModified = invoice.lastModified ? new Date(invoice.lastModified).toLocaleString() : 'N/A';
                html += `<tr>
                    <td>#${invoice.serialNumber}</td>
                    <td>${itemCount} items</td>
                    <td>${lastModified}</td>
                    <td><div class="invoice-actions">
                        <button class="open-invoice-btn" onclick="selectInvoice('${selectedDate}', ${invoice.serialNumber})">Open</button>
                        <button class="delete-invoice-btn" onclick="deleteInvoice('${selectedDate}', ${invoice.serialNumber})">Delete</button>
                    </div></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            renderAvailableDates();
        }

        // Select and load an invoice
        function selectInvoice(date, serial) {
            loadInvoice(date, serial);
            closeInvoiceList();
        }

        // Delete an invoice
        function deleteInvoice(date, serial) {
            if (confirm(`Delete invoice #${serial}?`)) {
                let invoices = getInvoicesForDate(date);
                invoices = invoices.filter(inv => inv.serialNumber !== serial);
                const key = getInvoiceStorageKey(date);
                localStorage.setItem(key, JSON.stringify(invoices));
                refreshInvoiceList();
                // If deleting current invoice, create new one
                if (currentInvoiceDate === date && currentInvoiceSerial === serial) {
                    items = [];
                    currentInvoiceSerial = getNextSerialNumber(date);
                    saveCurrentInvoice();
                    updateDisplay();
                }
            }
        }

        // Load items from current invoice
        function loadItemsFromStorage() {
            if (currentInvoiceDate) {
                const invoices = getInvoicesForDate(currentInvoiceDate);
                const invoice = invoices.find(inv => inv.serialNumber === currentInvoiceSerial);
                if (invoice) {
                    items = invoice.items || [];
                } else {
                    items = [];
                }
            } else {
                items = [];
            }
            updateTable();
        }

        // Save items to current invoice
        function saveItemsToStorage() {
            saveCurrentInvoice();
        }

        // --- Product management ---
        let products = [];

        function getProductsKey() {
            return 'products';
        }

        function loadProducts() {
            const stored = localStorage.getItem(getProductsKey());
            if (stored) {
                try {
                    products = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading products:', e);
                    products = [];
                }
            } else {
                products = [];
            }
        }

        function saveProducts() {
            localStorage.setItem(getProductsKey(), JSON.stringify(products));
        }

        function openProductManagement() {
            document.getElementById('productManagementModal').classList.add('show');
            renderProductTable();
        }

        function closeProductManagement() {
            document.getElementById('productManagementModal').classList.remove('show');
        }

        function renderProductTable() {
            const container = document.getElementById('productTableContainer');
            if (!products || products.length === 0) {
                container.innerHTML = '<p>No products defined.</p>';
                return;
            }

            let html = '<table class="product-table"><thead><tr><th>ID</th><th>Name</th><th>Weight</th><th>Default Cost</th><th>Actions</th></tr></thead><tbody>';
            products.forEach(p => {
                html += `<tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.weight}</td>
                    <td>${parseFloat(p.defaultCost).toFixed(2)}</td>
                    <td><div class="product-actions">
                        <button class="edit-btn" onclick="editProduct(${p.id})">Edit</button>
                        <button class="delete-btn" onclick="deleteProduct(${p.id})">Delete</button>
                    </div></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function openProductForm(id = null) {
            const form = document.getElementById('productForm');
            document.getElementById('productFormElement').reset();
            if (id !== null) {
                const p = products.find(x => x.id === id);
                if (p) {
                    document.getElementById('productId').value = p.id;
                    document.getElementById('productNameInput').value = p.name;
                    document.getElementById('productWeightInput').value = p.weight;
                    document.getElementById('productCostInput').value = p.defaultCost;
                }
            } else {
                const nextId = products.length ? Math.max(...products.map(x => x.id)) + 1 : 1;
                document.getElementById('productId').value = nextId;
            }
            form.classList.add('show');
        }

        function closeProductForm() {
            document.getElementById('productForm').classList.remove('show');
        }

        function submitProductForm() {
            const id = parseInt(document.getElementById('productId').value, 10);
            const name = document.getElementById('productNameInput').value.trim();
            const weight = parseFloat(document.getElementById('productWeightInput').value);
            const defaultCost = parseFloat(document.getElementById('productCostInput').value) || 0;

            if (!name) { alert('Product name required'); return; }

            const existing = products.find(p => p.id === id);
            if (existing) {
                existing.name = name;
                existing.weight = weight;
                existing.defaultCost = defaultCost;
            } else {
                products.push({ id, name, weight, defaultCost });
            }

            saveProducts();
            renderProductTable();
            populateProductSelect();
            closeProductForm();
        }

        function editProduct(id) {
            openProductForm(id);
        }

        function deleteProduct(id) {
            if (!confirm(`Delete product #${id}?`)) return;
            products = products.filter(p => p.id !== id);
            saveProducts();
            renderProductTable();
            populateProductSelect();
        }

        // Populate the product select used in the item form
        function populateProductSelect() {
            const sel = document.getElementById('productSelect');
            if (!sel) return;
            const prev = sel.value;
            // base options
            sel.innerHTML = '<option value="">-- Select product --</option><option value="add_new">+ Add new product...</option>';
            if (!products || products.length === 0) return;
            products.forEach(p => {
                const opt = document.createElement('option');
                opt.value = String(p.id);
                opt.text = `${p.name} (ID:${p.id})`;
                sel.appendChild(opt);
            });
            if (prev) sel.value = prev;
        }

        // Handle product selection from the item form
        function onProductSelectChange() {
            const val = document.getElementById('productSelect').value;
            if (!val) {
                document.getElementById('productName').value = '';
                document.getElementById('netWeight').value = '';
                document.getElementById('cost').value = '';
                return;
            }
            if (val === 'add_new') {
                // Open the product form to add a new product
                openProductForm();
                // reset selection until product is added
                document.getElementById('productSelect').value = '';
                return;
            }
            const id = parseInt(val, 10);
            const p = products.find(x => x.id === id);
            if (p) {
                document.getElementById('productName').value = p.name;
                document.getElementById('netWeight').value = p.weight;
                document.getElementById('cost').value = p.defaultCost;
            }
        }


        function openForm(index = -1) {
            const formElement = document.getElementById('itemForm');
            formElement.classList.add('show');
            if (index >= 0) {
                editingIndex = index;
                const item = items[index];
                document.getElementById('productName').value = item.productName;
                document.getElementById('netWeight').value = item.netWeight;
                document.getElementById('quantity').value = item.quantity;
                document.getElementById('rate').value = item.rate;
                document.getElementById('cost').value = item.cost;
            } else {
                editingIndex = -1;
                document.getElementById('form').reset();
                // Clear any lingering placeholder state
                document.getElementById('productName').value = '';
                document.getElementById('netWeight').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('rate').value = '';
                document.getElementById('cost').value = '';
            }
        }

        function closeForm() {
            document.getElementById('itemForm').classList.remove('show');
        }

        function submitForm() {
            const productName = document.getElementById('productName').value;
            const netWeight = parseFloat(document.getElementById('netWeight').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const rate = parseFloat(document.getElementById('rate').value);
            const cost = parseFloat(document.getElementById('cost').value) || 3;
            const unitPrice = netWeight * rate / 100;
            const totalPrice = unitPrice * quantity;

            const item = { productName, netWeight, quantity, rate, unitPrice, totalPrice, cost, finalUnitCost: unitPrice + cost };

            if (editingIndex >= 0) {
                items[editingIndex] = item;
            } else {
                items.push(item);
            }

            updateTable();
            saveItemsToStorage();
            closeForm();
        }

        function updateTable() {
            const tbody = document.getElementById('invoiceTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            let totalInvoicePrice = 0;
            let totalQuantity = 0;

            items.forEach((item, index) => {
                const row = tbody.insertRow();
                row.insertCell(0).innerText = item.productName;
                row.insertCell(1).innerText = item.netWeight;
                row.insertCell(2).innerText = item.rate;
                row.insertCell(3).innerText = item.quantity;
                row.insertCell(4).innerText = item.unitPrice.toFixed(2);
                row.insertCell(5).innerText = item.totalPrice.toFixed(2);
                row.insertCell(6).innerText = item.cost.toFixed(2);
                row.insertCell(7).innerText = item.finalUnitCost.toFixed(2);
                const actionsCell = row.insertCell(8);
                actionsCell.innerHTML = `
                   <button class="button" onclick="openForm(${index})">U</button>
                   <button class="button" onclick="removeItem(${index})">X</button>
               `;
                totalInvoicePrice += item.totalPrice;
                totalQuantity += item.quantity;
            });

            document.getElementById('totalQuantity').innerText = totalQuantity;
            document.getElementById('totalPrice').innerText = totalInvoicePrice.toFixed(2);
        }

        function removeItem(index) {
            items.splice(index, 1);
            updateTable();
            saveItemsToStorage();
        }
        function updateCost() {
            const netWeight = parseFloat(document.getElementById('netWeight').value);
            const costInput = document.getElementById('cost');
            ///costInput.value = netWeight === 50 ? 20 : 10;
            costInput.value = 3;
        }

        // Capture the invoice area and share or download as image
        function shareInvoice() {
            const header = document.getElementById('invoiceHeader');
            const table = document.getElementById('invoiceTable');
            if (!table) { alert('No invoice table available to share'); return; }

            // Build a temporary container with clones to ensure consistent rendering
            const temp = document.createElement('div');
            temp.style.background = '#fff';
            temp.style.color = '#000';
            temp.style.padding = '20px';
            temp.style.boxSizing = 'border-box';
            temp.style.maxWidth = '1200px';
            if (header) temp.appendChild(header.cloneNode(true));
            // Clone table and remove the Actions column before rendering
            const clonedTable = table.cloneNode(true);
            (function removeActionsColumn(t) {
                try {
                    // determine the actions column index by header text if present
                    let actionIndex = -1;
                    const thead = t.querySelector('thead');
                    if (thead && thead.rows && thead.rows[0]) {
                        const headerRow = thead.rows[0];
                        for (let i = 0; i < headerRow.cells.length; i++) {
                            const txt = headerRow.cells[i].innerText || '';
                            if (txt.trim().toLowerCase() === 'actions') { actionIndex = i; break; }
                        }
                        // fallback to last column
                        if (actionIndex === -1) actionIndex = headerRow.cells.length - 1;
                        if (actionIndex >= 0 && headerRow.cells[actionIndex]) headerRow.deleteCell(actionIndex);
                    }

                    const tbody = t.querySelector('tbody');
                    if (tbody) {
                        for (let r = 0; r < tbody.rows.length; r++) {
                            const row = tbody.rows[r];
                            if (actionIndex >= 0 && row.cells[actionIndex]) row.deleteCell(actionIndex);
                        }
                    }
                } catch (e) {
                    console.warn('Could not remove Actions column:', e);
                }
            })(clonedTable);
            temp.appendChild(clonedTable);
            const totalsDiv = document.createElement('div');
            totalsDiv.style.marginTop = '10px';
            totalsDiv.innerHTML = `Total quantity: <b>${document.getElementById('totalQuantity').innerText}</b>, Total Price: <b>${document.getElementById('totalPrice').innerText}</b>`;
            temp.appendChild(totalsDiv);

            // Temporarily add to body (offscreen) for rendering
            temp.style.position = 'fixed';
            temp.style.left = '-9999px';
            document.body.appendChild(temp);

            const filename = `invoice_${currentInvoiceDate}_#${currentInvoiceSerial}.png`;

            // Use html2canvas to render
            html2canvas(temp, {scale: 2}).then(canvas => {
                canvas.toBlob(blob => {
                    if (!blob) { alert('Failed to create image'); document.body.removeChild(temp); return; }

                    const file = new File([blob], filename, { type: 'image/png' });

                    // Try Web Share API with files if available
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: `Invoice ${currentInvoiceDate} #${currentInvoiceSerial}` })
                            .catch(() => openBlobInNewTab(blob, filename));
                    } else {
                        openBlobInNewTab(blob, filename);
                    }

                    document.body.removeChild(temp);
                }, 'image/png');
            }).catch(err => {
                alert('Screenshot failed: ' + err);
                document.body.removeChild(temp);
            });
        }

        function openBlobInNewTab(blob, filename) {
            const url = URL.createObjectURL(blob);
            const win = window.open(url, '_blank');
            if (!win) {
                // If popup blocked, force a download
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } else {
                // Revoke after a while
                setTimeout(() => URL.revokeObjectURL(url), 10000);
            }
        }

        function updateInvoiceDate() {
            const selectedDate = document.getElementById('datePicker').value;
            if (selectedDate) {
                currentInvoiceDate = selectedDate;
                // Load the first invoice for this date, or create a new one
                const invoices = getInvoicesForDate(selectedDate);
                if (invoices.length > 0) {
                    loadInvoice(selectedDate, invoices[0].serialNumber);
                } else {
                    // Create first invoice for this date
                    currentInvoiceSerial = 1;
                    items = [];
                    saveCurrentInvoice();
                    updateDisplay();
                }
            }
        }

        // Initialize the app on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            currentInvoiceDate = today;
            
            // Load or create first invoice for today
            const invoices = getInvoicesForDate(today);
            if (invoices.length > 0) {
                loadInvoice(today, invoices[0].serialNumber);
            } else {
                currentInvoiceSerial = 1;
                items = [];
                saveCurrentInvoice();
                updateDisplay();
            }

            // Load products and render product table
            loadProducts();
            renderProductTable();
            populateProductSelect();
        });

    </script>
</body>

</html>